### **Modbus RTU - 功能碼格式解析**

---

### **1. READ\_DISCRETE\_INPUTS (功能碼 0x02)**

**功能描述：** 讀取離散輸入 (Discrete Inputs) 的狀態，通常用於監控數位輸入設備 (如按鈕或感測器)。

---
#### **請求 (Request) 格式**

```
[地址] [功能碼] [起始地址] [數量] [CRC]
```

- **地址 (1 byte)** – 目標 Slave 設備地址 (1\~247)。
- **功能碼 (1 byte)** – 固定為 `0x02`，表示讀取離散輸入。
- **起始地址 (2 bytes)** – 讀取的起始離散輸入地址。
- **數量 (2 bytes)** – 要讀取的離散輸入數量。
- **CRC (2 bytes)** – 用於檢查數據完整性。

---
#### **回應 (Response) 格式**

```
[地址] [功能碼] [字節數] [數據] [CRC]
```

- **地址 (1 byte)** – Slave 設備地址。
- **功能碼 (1 byte)** – `0x02`，與請求功能碼相同。
- **字節數 (1 byte)** – 實際回應的數據長度 (每 8 個離散輸入佔 1 byte)。
- **數據 (N bytes)** – 離散輸入狀態 (每 bit 表示 1 個離散輸入，1 表示開啟，0 表示關閉)。
- **CRC (2 bytes)** – 校驗碼。

---

### **2. READ\_HOLDING\_REGISTERS (功能碼 0x03)**

**功能描述：** 讀取保持寄存器 (Holding Registers) 的值，通常用於讀取設備狀態或配置參數。

---
#### **請求 (Request) 格式**

```
[地址] [功能碼] [起始地址] [數量] [CRC]
```

- **地址 (1 byte)** – 目標 Slave 設備地址 (1\~247)。
- **功能碼 (1 byte)** – 固定為 `0x03`，表示讀取保持寄存器。
- **起始地址 (2 bytes)** – 讀取的起始寄存器地址。
- **數量 (2 bytes)** – 要讀取的連續寄存器數量。
- **CRC (2 bytes)** – 用於檢查數據完整性。

---
#### **回應 (Response) 格式**

```
[地址] [功能碼] [字節數] [數據] [CRC]
```

- **地址 (1 byte)** – Slave 設備地址。
- **功能碼 (1 byte)** – `0x03`，與請求功能碼相同。
- **字節數 (1 byte)** – 實際回應的數據長度 (寄存器數量 x 2)。
- **數據 (N bytes)** – 保持寄存器的值，每個寄存器 2 bytes。
- **CRC (2 bytes)** – 校驗碼。

---

### **3. WRITE\_SINGLE\_REGISTER (功能碼 0x06)**

**功能描述：** 向單個保持寄存器寫入數據，用於設置設備參數或狀態。

---
#### **請求 (Request) 格式**

```
[地址] [功能碼] [寄存器地址] [數據值] [CRC]
```

- **地址 (1 byte)** – 目標 Slave 設備地址 (1\~247)。
- **功能碼 (1 byte)** – 固定為 `0x06`，表示寫入單個寄存器。
- **寄存器地址 (2 bytes)** – 要寫入的寄存器地址。
- **數據值 (2 bytes)** – 寫入寄存器的數據 (16-bit)。
- **CRC (2 bytes)** – 用於檢查數據完整性。

---
#### **回應 (Response) 格式**

```
[地址] [功能碼] [寄存器地址] [數據值] [CRC]
```

- **地址 (1 byte)** – Slave 設備地址。
- **功能碼 (1 byte)** – `0x06`，與請求功能碼相同。
- **寄存器地址 (2 bytes)** – 寫入數據的寄存器地址。
- **數據值 (2 bytes)** – 寫入成功的數據值。
- **CRC (2 bytes)** – 校驗碼。

---

### **4. WRITE\_MULTIPLE\_REGISTERS (功能碼 0x10)**

**功能描述：** 向多個連續的保持寄存器寫入數據，適合批量設置設備參數。

---
#### **請求 (Request) 格式**

```
[地址] [功能碼] [起始地址] [寄存器數量] [字節數] [數據] [CRC]
```

- **地址 (1 byte)** – 目標 Slave 設備地址 (1\~247)。
- **功能碼 (1 byte)** – 固定為 `0x10`，表示寫入多個寄存器。
- **起始地址 (2 bytes)** – 開始寫入的寄存器地址。
- **寄存器數量 (2 bytes)** – 要寫入的寄存器數量。
- **字節數 (1 byte)** – 實際寫入的數據長度 (寄存器數量 x 2)。
- **數據 (N bytes)** – 連續寫入的數據，每個寄存器 2 bytes。
- **CRC (2 bytes)** – 校驗碼。

---
#### **回應 (Response) 格式**

```
[地址] [功能碼] [起始地址] [寄存器數量] [CRC]
```

- **地址 (1 byte)** – Slave 設備地址。
- **功能碼 (1 byte)** – `0x10`，與請求功能碼相同。
- **起始地址 (2 bytes)** – 寫入數據的起始寄存器地址。
- **寄存器數量 (2 bytes)** – 成功寫入的寄存器數量。
- **CRC (2 bytes)** – 校驗碼。

---

### **Modbus 異常碼 (Exception Codes) 說明**

| 異常碼 | 名稱                              | 描述                                                             |
|--------|-----------------------------------|------------------------------------------------------------------|
| `01`   | 非法功能碼 (Illegal Function)     | 發送的功能碼無效或不被支持                                         |
| `02`   | 非法數據地址 (Illegal Data Address)| 發送的數據地址超出範圍                                             |
| `03`   | 非法數據值 (Illegal Data Value)    | 發送的數據值超出允許範圍                                           |
| `04`   | Slave 設備故障 (Slave Device Failure)| Slave 設備內部發生不可恢復錯誤                                     |
| `05`   | 確認 (Acknowledge)                 | 請求已接收，但需要更長的時間來處理                                 |
| `06`   | 設備忙碌 (Slave Device Busy)       | Slave 設備忙碌，無法立即處理請求                                   |
| `07`   | 負載錯誤 (Negative Acknowledge)    | 請求未能處理，可能是功能不支持或其他錯誤                           |
| `08`   | 記憶體奇偶錯誤 (Memory Parity Error)| 在向寄存器讀/寫時發生奇偶校驗錯誤                                 |
| `0A`   | 閘道路徑不可用 (Gateway Path Unavailable)| 閘道不可達或無法通訊                                               |
| `0B`   | 閘道設備無法響應 (Gateway Target Device Failed to Respond)| 目標設備未能在規定時間內響應請求                                    |

---

### **異常碼通訊格式**

```
[地址] [功能碼 + 0x80] [異常碼] [CRC]
```

- **地址 (1 byte)** – Slave 設備地址。
- **功能碼 + 0x80 (1 byte)** – 發送的功能碼加上 `0x80` 表示異常回應。
- **異常碼 (1 byte)** – 指示具體異常原因的代碼。
- **CRC (2 bytes)** – 校驗碼，保證數據完整性。

